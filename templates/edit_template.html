{% extends 'base.html' %}

{% block content %}
<div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">{{ _('Editing Template') }}: <span class="fw-bold">{{ template.name }}</span></h4>
        <div>
            <a href="{{ url_for('certificates.list_templates') }}" class="btn btn-outline-secondary me-2">{{ _('Cancel') }}</a>
            <button id="saveBtn" class="btn btn-success"><i class="fas fa-save"></i> {{ _('Save Layout') }}</button>
        </div>
    </div>

    <div class="row">
        <!-- Toolbar -->
        <div class="col-md-3">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-light fw-bold">{{ _('Tools') }}</div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary text-start" onclick="addText()">
                            <i class="fas fa-font me-2"></i> {{ _('Add Text') }}
                        </button>
                        
                        <div class="input-group">
                            <select id="variableSelect" class="form-select">
                                <option value="{{ '{{ nom }}' }}">{{ _('Last Name') }}</option>
                                <option value="{{ '{{ prenom }}' }}">{{ _('First Name') }}</option>
                                <option value="{{ '{{ date }}' }}">{{ _('Event Date') }}</option>
                                <option value="{{ '{{ event_name }}' }}">{{ _('Event Name') }}</option>
                                <option value="{{ '{{ organizer }}' }}">{{ _('Organizer') }}</option>
                                <option value="{{ '{{ eligible_hours }}' }}">{{ _('Eligible Hours') }}</option>
                                <option value="{{ '{{ signature }}' }}">{{ _('Signature Image') }}</option>
                            </select>
                            <button class="btn btn-outline-primary" onclick="addVariable()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                        <div class="mt-2">
                            <label class="form-label small text-muted">{{ _('Upload Image') }}</label>
                            <input type="file" id="imageUpload" class="form-control form-control-sm" accept="image/*">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Properties Panel (Dynamic) -->
            <div class="card shadow-sm" id="propertiesPanel" style="display:none;">
                <div class="card-header bg-light fw-bold">{{ _('Properties') }}</div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="form-label small">{{ _('Font Size') }}</label>
                        <input type="number" id="propFontSize" class="form-control form-control-sm" value="16">
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">{{ _('Font Weight') }}</label>
                        <select id="propFontWeight" class="form-select form-select-sm">
                            <option value="normal">Normal</option>
                            <option value="bold">Bold</option>
                        </select>
                    </div>
                    <div class="mb-2">
                         <label class="form-label small">{{ _('Content') }}</label>
                         <textarea id="propContent" class="form-control form-control-sm" rows="2"></textarea>
                    </div>
                    <div class="d-grid mt-3">
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteSelectedElement()">
                            <i class="fas fa-trash"></i> {{ _('Delete Element') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Canvas Area -->
        <div class="col-md-9 bg-secondary bg-opacity-10 p-4 text-center overflow-auto" style="height: 80vh;">
            <div id="certificateCanvas" class="bg-white shadow mx-auto position-relative text-start" 
                 style="width: 794px; height: 1123px; overflow: hidden; transform-origin: top center;">
                <!-- Elements will be dropped here -->
            </div>
        </div>
    </div>
</div>

<!-- Interact.js -->
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

<script>
    const canvas = document.getElementById('certificateCanvas');
    const templateId = {{ template.id }};
    const csrfToken = "{{ csrf_token() }}";
    
    let selectedElement = null;
    let elements = []; // Store state

    // Initialize layout from DB
    const savedLayout = {{ template.layout_data|tojson }};
    if (savedLayout && savedLayout.elements) {
        savedLayout.elements.forEach(el => {
            renderElement(el);
        });
    }

    // --- Element Creation ---

    function createBaseElement(type, x, y, content) {
        const el = document.createElement('div');
        el.classList.add('draggable-element');
        el.dataset.type = type;
        el.style.position = 'absolute';
        
        // Use transform for positioning to work well with interact.js
        el.style.transform = `translate(${x}px, ${y}px)`;
        el.dataset.x = x;
        el.dataset.y = y;
        
        // Initial Styles
        el.style.cursor = 'move';
        el.style.border = '1px dashed transparent';
        el.style.padding = '5px';
        
        if (type === 'text' || type === 'variable') {
            if (type === 'variable' && content === '{{ signature }}') {
                 el.innerHTML = '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border: 1px solid #dee2e6; color: #6c757d; font-size: 12px; pointer-events: none;">[ SIGNATURE ]</div>';
                 el.dataset.content = content;
                 el.style.width = '200px';
                 el.style.height = '60px';
            } else {
                 el.innerText = content;
                 el.style.fontSize = '16px';
                 el.style.fontFamily = 'Arial, sans-serif';
                 el.style.whiteSpace = 'nowrap';
            }
        } else if (type === 'image') {
            const img = document.createElement('img');
            img.src = content;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.pointerEvents = 'none';
            el.appendChild(img);
            el.style.width = '100px';
            el.style.height = '100px';
        }
        
        // Selection Handler
        el.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            selectElement(el);
        });

        canvas.appendChild(el);
        return el;
    }

    function addText() {
        createBaseElement('text', 50, 50, 'New Text Block');
    }

    function addVariable() {
        const select = document.getElementById('variableSelect');
        const val = select.value;
        createBaseElement('variable', 50, 100, val);
    }

    // --- Image Upload ---
    document.getElementById('imageUpload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('image', file);
        formData.append('csrf_token', csrfToken);

        fetch("{{ url_for('certificates.upload_asset') }}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.url) {
                createBaseElement('image', 100, 100, data.url);
            } else {
                alert('Upload failed: ' + (data.error || 'Unknown error'));
            }
            // Reset input
            e.target.value = '';
        })
        .catch(err => {
            console.error(err);
            alert('Upload error');
        });
    });

    // --- Rendering Saved Elements ---
    function renderElement(data) {
        const type = data.type;
        const x = data.x || 0;
        const y = data.y || 0;
        const content = data.content;
        
        const el = createBaseElement(type, x, y, content);
        
        // Apply saved styles
        if (data.style) {
            if (data.style.fontSize) el.style.fontSize = data.style.fontSize;
            if (data.style.fontWeight) el.style.fontWeight = data.style.fontWeight;
            if (data.style.color) el.style.color = data.style.color;
            if (data.style.width) el.style.width = data.style.width;
            if (data.style.height) el.style.height = data.style.height;
        }
    }

    // --- Interactions (Drag & Resize) ---
    interact('.draggable-element')
        .draggable({
            listeners: { move: dragMoveListener },
            modifiers: [
                interact.modifiers.restrictRect({
                    restriction: 'parent',
                    endOnly: true
                })
            ]
        })
        .resizable({
            // resize from all edges and corners
            edges: { left: true, right: true, bottom: true, top: true },
            listeners: {
                move: function (event) {
                    let { x, y } = event.target.dataset;

                    x = (parseFloat(x) || 0) + event.deltaRect.left;
                    y = (parseFloat(y) || 0) + event.deltaRect.top;

                    Object.assign(event.target.style, {
                        width: `${event.rect.width}px`,
                        height: `${event.rect.height}px`,
                        transform: `translate(${x}px, ${y}px)`
                    });

                    Object.assign(event.target.dataset, { x, y });
                    
                    // If image, resize internal img
                    const img = event.target.querySelector('img');
                    if (img) {
                        img.style.width = '100%';
                        img.style.height = '100%';
                    }
                }
            },
            modifiers: [
                interact.modifiers.restrictEdges({
                    outer: 'parent'
                })
            ]
        });

    function dragMoveListener(event) {
        const target = event.target;
        // keep the dragged position in the data-x/data-y attributes
        const x = (parseFloat(target.dataset.x) || 0) + event.dx;
        const y = (parseFloat(target.dataset.y) || 0) + event.dy;

        // translate the element
        target.style.transform = `translate(${x}px, ${y}px)`;

        // update the posiion attributes
        target.dataset.x = x;
        target.dataset.y = y;
        
        // Select on drag
        selectElement(target);
    }

    // --- Selection & Properties ---
    function selectElement(el) {
        // Deselect previous
        if (selectedElement) {
            selectedElement.style.border = '1px dashed transparent';
        }
        
        selectedElement = el;
        selectedElement.style.border = '1px dashed #0d6efd';
        
        // Show properties
        document.getElementById('propertiesPanel').style.display = 'block';
        
        // Populate inputs
        const type = el.dataset.type;
        document.getElementById('propContent').value = (type === 'text' || type === 'variable') ? el.innerText : '';
        document.getElementById('propContent').disabled = (type === 'image');
        
        document.getElementById('propFontSize').value = parseInt(el.style.fontSize) || 16;
        document.getElementById('propFontWeight').value = el.style.fontWeight || 'normal';
    }

    // click outside to deselect
    canvas.addEventListener('mousedown', (e) => {
        if (e.target === canvas) {
            if (selectedElement) {
                selectedElement.style.border = '1px dashed transparent';
                selectedElement = null;
                document.getElementById('propertiesPanel').style.display = 'none';
            }
        }
    });
    
    // Property Change Listeners
    document.getElementById('propFontSize').addEventListener('input', (e) => {
        if (selectedElement) selectedElement.style.fontSize = e.target.value + 'px';
    });
    
    document.getElementById('propFontWeight').addEventListener('change', (e) => {
        if (selectedElement) selectedElement.style.fontWeight = e.target.value;
    });

    document.getElementById('propContent').addEventListener('input', (e) => {
        if (selectedElement && selectedElement.dataset.type !== 'image') {
            selectedElement.innerText = e.target.value;
        }
    });

    function deleteSelectedElement() {
        if (selectedElement) {
            selectedElement.remove();
            selectedElement = null;
            document.getElementById('propertiesPanel').style.display = 'none';
        }
    }

    // --- Save Routine ---
    document.getElementById('saveBtn').addEventListener('click', () => {
        const nodes = canvas.querySelectorAll('.draggable-element');
        const elementsData = [];

        nodes.forEach(node => {
            const type = node.dataset.type;
            const x = parseFloat(node.dataset.x) || 0;
            const y = parseFloat(node.dataset.y) || 0;
            const width = node.style.width;
            const height = node.style.height;
            const style = {
                fontSize: node.style.fontSize,
                fontWeight: node.style.fontWeight,
                color: node.style.color,
                width: width,
                height: height
            };

            let content = '';
            if (type === 'variable' && node.dataset.content) {
                content = node.dataset.content;
            } else if (type === 'text' || type === 'variable') {
                content = node.innerText;
            } else if (type === 'image') {
                content = node.querySelector('img').src;
            }

            elementsData.push({
                type, x, y, content, style
            });
        });

        const layoutData = {
            elements: elementsData
        };

        fetch(`/api/save_template/${templateId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(layoutData)
        })
        .then(res => res.json())
        .then(data => {
            alert('Saved successfully!');
        })
        .catch(err => {
            console.error(err);
            alert('Error saving layout');
        });
    });

</script>
{% endblock %}
