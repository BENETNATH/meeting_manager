{% extends 'base.html' %}

{% block content %}
<div class="container-fluid py-3">
    <div class="row justify-content-center">
        <div class="col-xl-9 col-lg-11">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h1 class="h5 fw-bold mb-0"><i class="fas fa-plus-circle me-2 text-primary"></i>{{ _('Create Event') }}</h1>
                    <p class="text-muted small mb-0">{{ _('Fill in the details for your new meeting') }}</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('events.index') }}" class="btn btn-outline-primary">{{ _('Cancel') }}</a>
                    <button type="submit" form="eventForm" class="btn btn-primary px-3">{{ _('Create Event') }}</button>
                </div>
            </div>

            <form id="eventForm" method="POST" enctype="multipart/form-data" action="{{ url_for('events.create_event') }}" onsubmit="return validateForm()">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="row g-2">
                    <!-- Core Info -->
                    <div class="col-md-7">
                        <div class="detail-section">
                            <div class="section-title-compact">{{ _('General') }}</div>
                            <div class="mb-2">
                                <label class="form-label-compact">{{ _('Event Title') }}</label>
                                <input type="text" id="title" name="title" class="form-control-compact" value="{{ form_data.get('title', '') }}" required>
                            </div>
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label-compact">{{ _('Organizer') }}</label>
                                    <input type="text" id="organizer" name="organizer" class="form-control-compact" value="{{ form_data.get('organizer', '') }}" required>
                                </div>
                                <div class="col-6">
                                    <label class="form-label-compact">{{ _('Location') }}</label>
                                    <input type="text" id="location" name="location" class="form-control-compact" value="{{ form_data.get('location', '') }}">
                                </div>
                            </div>

                            <div class="section-title-compact mt-3">{{ _('Schedule') }}</div>
                            <div class="row g-2">
                                <div class="col-4">
                                    <label class="form-label-compact">{{ _('Date') }}</label>
                                    <input type="date" id="date" name="date" class="form-control-compact" value="{{ form_data.get('date', '') }}" required>
                                </div>
                                <div class="col-4">
                                    <label class="form-label-compact">{{ _('Start') }}</label>
                                    <input type="time" name="start_time" class="form-control-compact" value="{{ form_data.get('start_time', '') }}">
                                </div>
                                <div class="col-4">
                                    <label class="form-label-compact">{{ _('End') }}</label>
                                    <input type="time" name="end_time" class="form-control-compact" value="{{ form_data.get('end_time', '') }}">
                                </div>
                                <div class="col-6">
                                    <label class="form-label-compact">{{ _('Timezone') }}</label>
                                    <input type="text" name="timezone" class="form-control-compact" list="timezone-list" value="{{ form_data.get('timezone', 'UTC') }}" required>
                                    <datalist id="timezone-list">
                                        {% for tz in timezones %}<option value="{{ tz }}">{% endfor %}
                                    </datalist>
                                </div>
                                <div class="col-3">
                                    <label class="form-label-compact">{{ _('Hrs') }}</label>
                                    <input type="number" step="0.1" name="eligible_hours" class="form-control-compact" value="{{ form_data.get('eligible_hours', '0') }}">
                                </div>
                                <div class="col-3">
                                    <label class="form-label-compact">{{ _('Status') }}</label>
                                    <select name="status" class="form-control-compact">
                                        <option value="visible" {% if form_data.get('status') == 'visible' %}selected{% endif %}>{{ _('Visible') }}</option>
                                        <option value="hidden" {% if form_data.get('status') == 'hidden' %}selected{% endif %}>{{ _('Hidden') }}</option>
                                        <option value="archived" {% if form_data.get('status') == 'archived' %}selected{% endif %}>{{ _('Archived') }}</option>
                                        <option value="password-protected" {% if form_data.get('status') == 'password-protected' %}selected{% endif %}>{{ _('Protected') }}</option>
                                    </select>
                                </div>
                                <div class="col-6" id="passwordGroup" style="display: none;">
                                    <label class="form-label-compact">{{ _('Password') }}</label>
                                    <input type="password" name="event_password" class="form-control-compact" placeholder="{{ _('Set password') }}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Media & Sidebar -->
                    <div class="col-md-5">
                        <div class="detail-section mb-2">
                            <div class="section-title-compact">{{ _('Media') }}</div>
                            <div class="flex-grow-1 mb-2">
                                <input type="file" name="picture" class="form-control-compact" accept="image/*">
                            </div>
                            <input type="url" name="photo_url" class="form-control-compact" placeholder="External URL" value="{{ form_data.get('photo_url', '') }}">
                        </div>

                        <div class="detail-section">
                            <div class="section-title-compact">{{ _('Documents') }}</div>
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="form-label-compact">{{ _('Certificate Template') }}</label>
                                    <select name="template_id" class="form-control-compact">
                                        <option value="">{{ _('Default / None') }}</option>
                                        {% for t in templates %}
                                            <option value="{{ t.id }}" {% if form_data.get('template_id')|int == t.id %}selected{% endif %}>{{ t.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label-compact">Signature (IMG)</label>
                                    <input type="file" name="signature" class="form-control-compact" accept="image/*">
                                </div>
                                <div class="col-12">
                                    <label class="form-label-compact">Registry / Program (PDF)</label>
                                    <div class="d-flex gap-1">
                                        <input type="file" name="registry_form" class="form-control-compact">
                                        <input type="file" name="pdf_program" class="form-control-compact">
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label-compact">Others</label>
                                    <input type="file" name="additional_files" class="form-control-compact" multiple>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Editors -->
                    <div class="col-12">
                        <div class="detail-section">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <div class="section-title-compact">{{ _('Description') }}</div>
                                    <div id="description_editor">{{ form_data.get('description', '') | safe }}</div>
                                    <input type="hidden" name="description">
                                </div>
                                <div class="col-md-6">
                                    <div class="section-title-compact">{{ _('Program') }}</div>
                                    <div id="program_editor">{{ form_data.get('program', '') | safe }}</div>
                                    <input type="hidden" name="program">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var quillDesc = new Quill('#description_editor', { theme: 'snow' });
        var quillProg = new Quill('#program_editor', { theme: 'snow' });

        // Initialisation des champs cach√©s
        document.querySelector('input[name="description"]').value = quillDesc.root.innerHTML;
        document.querySelector('input[name="program"]').value = quillProg.root.innerHTML;

        quillDesc.on('text-change', function() {
            document.querySelector('input[name="description"]').value = quillDesc.root.innerHTML;
        });
        quillProg.on('text-change', function() {
            document.querySelector('input[name="program"]').value = quillProg.root.innerHTML;
        });

        // Toggle password field
        const statusSelect = document.querySelector('select[name="status"]');
        const passwordGroup = document.getElementById('passwordGroup');
        
        function togglePassword() {
            passwordGroup.style.display = statusSelect.value === 'password-protected' ? 'block' : 'none';
        }
        
        statusSelect.addEventListener('change', togglePassword);
        togglePassword(); // Initial state
    });

    function validateForm() {
        const title = document.getElementById('title').value;
        const date = document.getElementById('date').value;
        if (!title.trim() || !date) {
            alert('Required fields missing');
            return false;
        }
        return true;
    }
</script>
{% endblock %}
