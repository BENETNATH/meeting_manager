{% extends 'base.html' %}

{% block content %}
<div class="container-fluid py-3">
    <div class="row justify-content-center">
        <div class="col-xl-9 col-lg-11">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h1 class="h5 fw-bold mb-0"><i class="fas fa-edit me-2 text-primary"></i>{{ _('Edit Event') }}</h1>
                    <p class="text-muted small mb-0">{{ event.title }}</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('events.event', event_id=event.id) }}" class="btn btn-outline-primary">{{ _('Cancel') }}</a>
                    <button type="submit" form="eventForm" class="btn btn-primary px-3">{{ _('Save Changes') }}</button>
                </div>
            </div>

            <form id="eventForm" method="POST" enctype="multipart/form-data" action="{{ url_for('events.edit_event', event_id=event.id) }}" onsubmit="return validateForm()">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="row g-2">
                    <!-- Core Info -->
                    <div class="col-md-7">
                        <div class="detail-section h-100">
                            <div class="section-title-compact">{{ _('General') }}</div>
                            <div class="mb-2">
                                <label class="form-label-compact">{{ _('Event Title') }}</label>
                                <input type="text" id="title" name="title" class="form-control-compact" value="{{ event.title }}" required>
                            </div>
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label-compact">{{ _('Organizer') }}</label>
                                    <input type="text" id="organizer" name="organizer" class="form-control-compact" value="{{ event.organizer }}" required>
                                </div>
                                <div class="col-6">
                                    <label class="form-label-compact">{{ _('Location') }}</label>
                                    <input type="text" id="location" name="location" class="form-control-compact" value="{{ event.location }}">
                                </div>
                            </div>

                            <div class="section-title-compact mt-3">{{ _('Schedule') }}</div>
                            <div class="row g-2">
                                <div class="col-4">
                                    <label class="form-label-compact">{{ _('Date') }}</label>
                                    <input type="date" id="date" name="date" class="form-control-compact" value="{{ event.date.strftime('%Y-%m-%d') }}" required>
                                </div>
                                <div class="col-4">
                                    <label class="form-label-compact">{{ _('Start') }}</label>
                                    <input type="time" name="start_time" class="form-control-compact" value="{{ event.start_time.strftime('%H:%M') if event.start_time else '' }}">
                                </div>
                                <div class="col-4">
                                    <label class="form-label-compact">{{ _('End') }}</label>
                                    <input type="time" name="end_time" class="form-control-compact" value="{{ event.end_time.strftime('%H:%M') if event.end_time else '' }}">
                                </div>
                                <div class="col-6">
                                    <label class="form-label-compact">{{ _('Timezone') }}</label>
                                    <input type="text" name="timezone" class="form-control-compact" list="timezone-list" value="{{ event.timezone }}" required>
                                    <datalist id="timezone-list">
                                        {% for tz in timezones %}<option value="{{ tz }}">{% endfor %}
                                    </datalist>
                                </div>
                                <div class="col-3">
                                    <label class="form-label-compact">{{ _('Hrs') }}</label>
                                    <input type="number" step="0.1" name="eligible_hours" class="form-control-compact" value="{{ event.eligible_hours }}">
                                </div>
                                <div class="col-3">
                                    <label class="form-label-compact">{{ _('Status') }}</label>
                                    <select name="status" class="form-control-compact">
                                        <option value="visible" {% if event.status == 'visible' %}selected{% endif %}>{{ _('Visible') }}</option>
                                        <option value="hidden" {% if event.status == 'hidden' %}selected{% endif %}>{{ _('Hidden') }}</option>
                                        <option value="archived" {% if event.status == 'archived' %}selected{% endif %}>{{ _('Archived') }}</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Media & Sidebar -->
                    <div class="col-md-5">
                        <div class="detail-section mb-2">
                            <div class="section-title-compact">{{ _('Media') }}</div>
                            <div class="d-flex gap-2 mb-2 align-items-center">
                                <div style="width: 48px; height: 48px; border-radius: 4px; overflow: hidden; background: #f1f5f9; flex-shrink: 0;">
                                    {% if event.photo_filename %}
                                        <img src="{{ url_for('events.uploaded_file', filename=event.photo_filename) }}" class="w-100 h-100 object-fit-cover">
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <input type="file" name="picture" class="form-control-compact" accept="image/*">
                                </div>
                            </div>
                            <input type="url" name="photo_url" class="form-control-compact" placeholder="External URL" value="{{ event.photo_url }}">
                        </div>

                        <div class="detail-section">
                            <div class="section-title-compact">{{ _('Documents') }}</div>
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="form-label-compact">Signature (IMG)</label>
                                    <input type="file" name="signature" class="form-control-compact" accept="image/*">
                                </div>
                                <div class="col-12">
                                    <label class="form-label-compact">Registry / Program (PDF)</label>
                                    <div class="d-flex gap-1">
                                        <input type="file" name="registry_form" class="form-control-compact">
                                        <input type="file" name="pdf_program" class="form-control-compact">
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label-compact">Others</label>
                                    <input type="file" name="additional_files" class="form-control-compact" multiple>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Editors -->
                    <div class="col-12">
                        <div class="detail-section">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <div class="section-title-compact">{{ _('Description') }}</div>
                                    <div id="description_editor" style="height: 120px; background: white;">{{ event.description | safe }}</div>
                                    <input type="hidden" name="description" value="{{ event.description | safe }}">
                                </div>
                                <div class="col-md-6">
                                    <div class="section-title-compact">{{ _('Program') }}</div>
                                    <div id="program_editor" style="height: 120px; background: white;">{{ event.program | safe }}</div>
                                    <input type="hidden" name="program" value="{{ event.program | safe }}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="detail-section bg-light border-0 py-2">
                            <div class="form-check mb-0">
                                <input class="form-check-input" type="checkbox" name="notify_time_change" id="notify" value="true">
                                <label class="form-check-label small fw-bold" for="notify">{{ _('Notify attendees') }}</label>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var quillDesc = new Quill('#description_editor', { theme: 'snow' });
        var quillProg = new Quill('#program_editor', { theme: 'snow' });

        quillDesc.on('text-change', function() {
            document.querySelector('input[name="description"]').value = quillDesc.root.innerHTML;
        });
        quillProg.on('text-change', function() {
            document.querySelector('input[name="program"]').value = quillProg.root.innerHTML;
        });
    });

    function validateForm() {
        const title = document.getElementById('title').value;
        const date = document.getElementById('date').value;
        if (!title.trim() || !date) {
            alert('Required fields missing');
            return false;
        }
        return true;
    }
</script>
{% endblock %}
