{% extends 'base.html' %}

{% block content %}
<header class="header-compact">
    <div class="container-fluid">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h1>{{ _('Attendance Management') }}</h1>
                <div class="header-meta">
                    <span><i class="fas fa-calendar-check text-primary"></i> {{ event.title }}</span>
                    <span><i class="fas fa-users"></i> {{ registrations|length }} {{ _('Registered') }}</span>
                    <span class="text-success"><i class="fas fa-user-check"></i> {{ registrations|selectattr('attended')|list|length }} {{ _('Present') }}</span>
                </div>
            </div>
            <a href="{{ url_for('events.event', event_id=event.id) }}" class="btn btn-outline-primary shadow-sm">
                <i class="fas fa-arrow-left me-1"></i> {{ _('Back to Event') }}
            </a>
        </div>
    </div>
</header>

<div class="container-fluid py-3">
    <div class="row g-3">
        <!-- Sidebar Tools -->
        <div class="col-lg-3">
            <div class="detail-section mb-3">
                <div class="section-title-compact">{{ _('Bulk Check-in') }}</div>
                <p class="x-small text-muted mb-2">{{ _('Paste emails here (comma/newline separated) to mark multiple attendees as present.') }}</p>
                <textarea class="form-control-compact mb-2" id="bulk-emails" rows="4" placeholder="email1@example.com, email2@example.com"></textarea>
                <button type="button" class="btn btn-primary w-100 py-1 shadow-sm" onclick="extractAndMarkAttendance()">
                    <i class="fas fa-magic me-1"></i> {{ _('Bulk Check') }}
                </button>
            </div>

            <div class="detail-section mb-3">
                <div class="section-title-compact">{{ _('Import List') }}</div>
                <form id="upload-form" enctype="multipart/form-data">
                    <input type="file" id="file-input" class="form-control-compact mb-2" accept=".csv, .xlsx">
                    <button type="submit" class="btn btn-outline-primary w-100 py-1">
                        <i class="fas fa-upload me-1"></i> {{ _('Import CSV/XLSX') }}
                    </button>
                </form>
            </div>

            <div class="detail-section">
                <div class="section-title-compact">{{ _('Export') }}</div>
                <a href="{{ url_for('events.extract_attendance', event_id=event.id) }}" class="btn btn-outline-secondary w-100 py-1">
                    <i class="fas fa-download me-1"></i> {{ _('Export to CSV') }}
                </a>
            </div>
        </div>

        <!-- Main List -->
        <div class="col-lg-9">
            <div class="detail-section p-0 overflow-hidden">
                <form method="POST" id="attendance-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="table-responsive">
                        <table class="table-compact table-hover w-100">
                            <thead>
                                <tr>
                                    <th>{{ _('Attendee') }}</th>
                                    <th>{{ _('Email') }}</th>
                                    <th>{{ _('Registration Key') }}</th>
                                    <th class="text-center">{{ _('Present') }}</th>
                                    <th class="text-end">{{ _('Actions') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for registration in registrations %}
                                    <tr>
                                        <td>
                                            <div class="fw-bold text-slate-900">{{ registration.first_name }} {{ registration.last_name }}</div>
                                        </td>
                                        <td><span class="x-small text-slate-500">{{ registration.email }}</span></td>
                                        <td><code class="x-small text-primary">{{ registration.unique_key }}</code></td>
                                        <td class="text-center">
                                            <input type="checkbox" class="form-check-input" name="attended_{{ registration.id }}" {% if registration.attended %}checked{% endif %} data-email="{{ registration.email|strip_html }}">
                                        </td>
                                        <td class="text-end">
                                            <button type="button" onclick="deleteRegistration({{ registration.id }})" class="btn-icon text-danger" title="{{ _('Delete') }}">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="p-2 bg-slate-50 border-top d-flex gap-2 justify-content-end">
                        <button type="submit" name="action" value="check_all" class="btn btn-sm btn-outline-primary">{{ _('Check All') }}</button>
                        <button type="submit" name="action" value="update_attendance" class="btn btn-sm btn-success px-4">{{ _('Update Presence') }}</button>
                        <button type="submit" name="action" value="save_new_registrations" class="btn btn-sm btn-info text-white">{{ _('Save Imports') }}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Structure -->
<div id="mappingModal" class="modal">
  <div class="modal-content border-0 shadow-lg rounded-2">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold mb-0">{{ _('Map Columns') }}</h5>
        <span id="closeModal" class="close text-slate-400">&times;</span>
    </div>
    <div id="mapping-container" class="mb-4"></div>
    <div class="d-grid">
        <button id="mapColumnsButton" class="btn btn-primary">{{ _('Import and Map') }}</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

<script>
    function extractAndMarkAttendance() {
        const emails = document.getElementById('bulk-emails').value.split(/[\n,]+/);
        let countChecked = 0;

        emails.forEach(email => {
            const cleanEmail = email.trim().replace(/<.*?>/g, '');
            const checkbox = document.querySelector(`input[type="checkbox"][data-email="${cleanEmail}"]`);
            if (checkbox) {
                checkbox.checked = true;
                countChecked++;
            }
        });

        if (countChecked > 0) {
            alert(`${countChecked} {{ _('attendees checked. Click "Update Presence" to save changes.') }}`);
        } else {
            alert('{{ _('No matching emails found in list.') }}');
        }
    }

    function deleteRegistration(registrationId) {
        if (!confirm('{{ _('Are you sure you want to delete this registration?') }}')) return;
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/delete_registration/${registrationId}`;
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'action';
        input.value = 'delete_' + registrationId;
        form.appendChild(input);

        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        form.appendChild(csrfInput);

        document.body.appendChild(form);
        form.submit();
    }

    document.getElementById('upload-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = e.target.result;
                let parsedData;
                if (file.name.endsWith('.csv')) {
                    parsedData = Papa.parse(data, { header: true }).data;
                } else if (file.name.endsWith('.xlsx')) {
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    parsedData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                }
                const columns = Object.keys(parsedData[0]);
                displayColumnsForMapping(columns, parsedData);
                document.getElementById('mappingModal').style.display = 'block';
            };
            if (file.name.endsWith('.xlsx')) reader.readAsBinaryString(file);
            else reader.readAsText(file);
        }
    });

    function displayColumnsForMapping(columns, parsedData) {
        const mappingContainer = document.getElementById('mapping-container');
        mappingContainer.innerHTML = '';
        const fields = ['last_name', 'first_name', 'email', 'present'];
        const selects = {};

        fields.forEach(field => {
            const div = document.createElement('div');
            div.className = 'mb-2';
            div.innerHTML = `<label class="form-label-compact d-block">Map ${field.replace('_', ' ')}:</label>`;
            const select = document.createElement('select');
            select.className = 'form-control-compact';
            columns.forEach(col => {
                const opt = document.createElement('option');
                opt.value = col; opt.textContent = col;
                select.appendChild(opt);
            });
            div.appendChild(select);
            mappingContainer.appendChild(div);
            selects[field] = select;
        });

        document.getElementById('mapColumnsButton').onclick = function() {
            const mapping = {};
            fields.forEach(f => mapping[f] = selects[f].value);
            addDataToTable(parsedData, mapping);
            document.getElementById('mappingModal').style.display = 'none';
        };
        document.getElementById('closeModal').onclick = () => document.getElementById('mappingModal').style.display = 'none';
    }

    function addDataToTable(parsedData, mapping) {
        const tableBody = document.querySelector('#attendance-form tbody');
        const form = document.getElementById('attendance-form');
        parsedData.forEach((row, index) => {
            if (row[mapping['email']]) {
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td><div class="fw-bold text-primary">${row[mapping['first_name']] || ''} ${row[mapping['last_name']] || ''}</div></td>
                    <td><span class="x-small text-slate-500">${row[mapping['email']]}</span></td>
                    <td><code class="x-small text-muted">NEW</code></td>
                    <td class="text-center"><input type="checkbox" class="form-check-input" name="attended_new_${index}" ${row[mapping['present']] === true ? 'checked' : ''}></td>
                    <td class="text-end"><button type="button" class="btn-icon text-danger" onclick="this.closest('tr').remove()"><i class="fas fa-trash-alt"></i></button></td>
                `;
                tableBody.appendChild(newRow);
                ['last_name', 'first_name', 'email'].forEach(field => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = `${field}_new_${index}`;
                    input.value = row[mapping[field]] || '';
                    form.appendChild(input);
                });
            }
        });
    }
</script>

<style>
.modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); }
.modal-content { background: white; margin: 10% auto; padding: 1.5rem; width: 90%; max-width: 400px; }
.close { font-size: 1.5rem; font-weight: 700; cursor: pointer; }
.btn-icon { background: none; border: none; padding: 4px; transition: var(--transition); }
.btn-icon:hover { background: var(--slate-100); border-radius: 4px; }
</style>
{% endblock %}